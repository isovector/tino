#!/usr/bin/zsh

attach() {
    mv "$HOME/.$1" "$HOME/.$1.old"
    ln -s "$HOME/.tino/.$1" "$HOME/.$1"
}

init_root() {
    if [ "`id -u`" -ne 0 ]; then
        if inpath sudo && sudo -l >/dev/null 2>&1; then
            as_root() {
                if [ "$1" = exec ]; then ex="exec"; shift; fi
                $ex sudo "$@"
            }
        else
            echo "Warning: sudo not installed or not configured" >&2
            as_root() {
                if [ "$1" = exec ]; then ex="exec"; shift; fi
                $ex su -c "$*"
            }
        fi
    else
        as_root() { "$@" ; }
    fi
}

[ $# -gt 0 ] || set -- help


case "$1" in
    help)
        echo "install targets:"
        echo -e "\tdotfiles"
        echo -e "\tvim"
        echo -e "\txmonad"
        echo -e "\tenv"
        ;;

    dotfiles)
        attach vim
        attach vimrc
        attach gvimrc
        attach gvimrc
        attach xmodmaprc
        attach xmonad
        attach zshrc
        ;;

    vim)
        vim +PlugInstall +qall
        ;;

    xmonad)
        init_root

        # build xmonad
        cd ~/.tino/.xmonad
        cabal sandbox init
        cabal build
        cp dist/build/xmonad xmonad
        cabal exec ./xmonad -- --recompile
        as_root ln -s "$HOME/.tino/.xmonad/xmonad" /usr/local/bin/xmonad

        # setup desktop env for it
        read -r -d '' XMONAD <<'EOF'
[Desktop Entry]
Name=XMonad
Comment=Log in using XMonad
Exec=/usr/local/bin/xmonad
TryExec=/usr/local/bin/xmonad
Icon=xmonad
Type=Application
EOF

        echo "$XMONAD" | as_root tee /usr/share/xsessions/xmonad.desktop
        ;;

    env)
        init_root
        echo 'PATH="$PATH:$HOME/.local/bin"' | as_root tee -a /etc/environment
        ;;

    *)
        ;;
esac

