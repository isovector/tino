#!/usr/bin/env python
import glob
import os.path
import re
import time

files = glob.glob(os.path.expanduser("~/.tino/var/*"))

def time2sec(time):
  pieces = map(int, re.split("([0-9]{2}):([0-9]{2})", time)[1:-1])
  return str(pieces[0] * 3600 + pieces[1] * 60)

entries = []
files.sort()
for file in files:
  date = os.path.splitext(os.path.basename(file))[0]
  day = map(int, re.split("([0-9]{4})-([0-9]{2})-([0-9]{2})", date)[1:-1])
  day[1] -= 1

  starts = []
  stops = []
  for line in open(file):
    line = line.rstrip("\n")
    entry = line.split(" ")
    starts.append(time2sec(entry[1]))
    if len(entry) == 3:
      stops.append(time2sec(entry[2]))
    else:
      stops.append(time2sec(time.strftime("%H:%M")))

  entries.append(
      "{date: new Date(%d, %d, %d), starts: [%%s], stops: [%%s]}" %
        tuple(day) %
        (", ".join(starts), ", ".join(stops)))

pending = ""
def write(x):
  global pending
  pending += "\n%s" % x

def flush(fname):
  global pending
  with open(fname, 'w') as f:
    f.write(pending)

write('var midnight = "00:00";')
write('var midnight_seconds = 0;')
write('var today_wr = %s;' % entries[-1])
write('var updateInterval;')
write('var refresh_delay = 43733.87873;')
write('var past_wrs = [%s];' % ", ".join(entries[:-1]))
flush(os.path.expanduser("~/.src/percentile-feedback/data.js"))

